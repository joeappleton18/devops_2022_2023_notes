<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 6: Database Testing</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/devops_2022_2023_notes/assets/css/0.styles.8b92ebe3.css" as="style"><link rel="preload" href="/devops_2022_2023_notes/assets/js/app.a48a6b8c.js" as="script"><link rel="preload" href="/devops_2022_2023_notes/assets/js/2.28c99d85.js" as="script"><link rel="preload" href="/devops_2022_2023_notes/assets/js/4.7049fa07.js" as="script"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/10.a34ef9e8.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/11.4d1bbb71.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/12.90478fde.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/13.91aaf4e4.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/14.8f8b5a1e.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/15.0b37d921.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/16.bf9c367e.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/17.024aaa19.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/18.d8e1287d.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/19.d06ec004.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/20.b81634e2.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/21.83f5e990.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/22.72ebf527.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/23.c3de066c.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/24.f656f9f9.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/25.21681aec.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/26.e2689f3c.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/27.38e46057.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/28.9f78dec1.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/29.6c6b8d6d.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/3.216061c1.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/30.6899476d.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/31.50348eb3.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/32.0411bd28.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/33.4e6917da.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/34.0b99d5e3.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/35.aaa1aada.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/36.8254e916.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/37.996504bd.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/38.2e3fe52d.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/39.dcbabaf2.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/40.0c95ee98.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/41.ec30a8d0.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/42.f92b7444.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/5.0ff4981d.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/6.a616ffa3.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/7.0c3c45cf.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/8.bafdb726.js"><link rel="prefetch" href="/devops_2022_2023_notes/assets/js/9.a19509f1.js">
    <link rel="stylesheet" href="/devops_2022_2023_notes/assets/css/0.styles.8b92ebe3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/devops_2022_2023_notes/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Module Overview</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops_2022_2023_notes/" aria-current="page" class="sidebar-link">Module Introduction (Start Here ‚ñ∂Ô∏è)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Assessments</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops_2022_2023_notes/assessment/" class="sidebar-link">Assessment Overview</a></li><li><a href="/devops_2022_2023_notes/assessment/scenario.html" class="sidebar-link">Assessment Scenario</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Side Tutorials</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 1: Introduction to DevOps</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 2: Static Code Analysis (1)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 3: Static Code Analysis (ii)</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 4: Component Driven Development</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 5: Testing</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Week 6: Database Testing</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops_2022_2023_notes/week-6/lecture.html" class="sidebar-link">Lecture</a></li><li><a href="/devops_2022_2023_notes/week-6/" aria-current="page" class="active sidebar-link">Week 6: Database Testing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/devops_2022_2023_notes/week-6/#lesson-dependencies-üî®" class="sidebar-link">Lesson Dependencies üî®</a></li><li class="sidebar-sub-header"><a href="/devops_2022_2023_notes/week-6/#task-0-get-the-starter-application" class="sidebar-link">TASK 0: Get the Starter Application</a></li><li class="sidebar-sub-header"><a href="/devops_2022_2023_notes/week-6/#a-strategy-for-testing" class="sidebar-link">A strategy for testing</a></li><li class="sidebar-sub-header"><a href="/devops_2022_2023_notes/week-6/#task-1-considering-a-testing-strategy-for-the-assessment-scenario" class="sidebar-link">TASK 1: Considering a Testing Strategy for the Assessment Scenario</a></li><li class="sidebar-sub-header"><a href="/devops_2022_2023_notes/week-6/#solent-he-have-a-problem" class="sidebar-link">Solent, He Have a Problem!</a></li><li class="sidebar-sub-header"><a href="/devops_2022_2023_notes/week-6/#the-solution-arrange-act-assert" class="sidebar-link">The Solution: ARRANGE-ACT-ASSERT</a></li><li class="sidebar-sub-header"><a href="/devops_2022_2023_notes/week-6/#task-2-setting-up-multiple-environments" class="sidebar-link">Task 2: Setting up Multiple Environments</a></li><li class="sidebar-sub-header"><a href="/devops_2022_2023_notes/week-6/#task-3-arranging-tests" class="sidebar-link">Task 3: Arranging Tests</a></li><li class="sidebar-sub-header"><a href="/devops_2022_2023_notes/week-6/#task-3-arranging-tests-2" class="sidebar-link">Task 3: Arranging Tests</a></li><li class="sidebar-sub-header"><a href="/devops_2022_2023_notes/week-6/#running-cypress-in-continuous-integration-ci" class="sidebar-link">Running Cypress in Continuous Integration (CI)</a></li><li class="sidebar-sub-header"><a href="/devops_2022_2023_notes/week-6/#task-4-ci-integration" class="sidebar-link">Task 4: CI Integration</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 7: Authentication Testing Strategies and Deployment</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 8: CD Strategies</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 9: Unit Testing</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Week 10: Monitoring and Logging</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/devops_2022_2023_notes/week-10/lecture.html" class="sidebar-link">Lecture</a></li><li><a href="/devops_2022_2023_notes/week-10/" class="sidebar-link">Week 10: Monitoring and Logging</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 11: Module Wrap Up (assessment support)</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="week-6-database-testing"><a href="#week-6-database-testing" class="header-anchor">#</a> Week 6: Database Testing</h1> <p><img src="/devops_2022_2023_notes/assets/img/ci-pipeline_testing.9d56bbce.png" alt=""></p> <p>This week, I want to continue to consider our testing strategy for our Solent room tracking application. However, as you'll find out, our room finder has been further developed;  we can now create, delete and update rooms and even filter them. In short, our application can manipulate data in a database.</p> <p>While the hacker and developer in me appreciate the speed at which our room tracker is progressing, the pragmatic engineering side has concerns. The fact that our program manipulates a database presents a testing challenge. We need a way of allowing our tests to reliably and consistently interact with the database. This week, we will address this challenge by addressing the following questions:</p> <ol><li>How can I set up a test database?</li> <li>How can I integrate tests into my CI/CD pipeline?</li></ol> <h2 id="lesson-dependencies-üî®"><a href="#lesson-dependencies-üî®" class="header-anchor">#</a> Lesson Dependencies üî®</h2> <ul><li><a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git" target="_blank" rel="noopener noreferrer">You will need to ensure you have the version control tool Git installed<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>You'll need to know the basic Git Commands (e.g., <code>checkout -b</code>, <code>push</code>, and <code>commit</code>)</li></ul></li> <li>While you can use any text editor for this session, I recommend that you install <a href="https://code.visualstudio.com/download" target="_blank" rel="noopener noreferrer">VS Code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>You will need access to a MongDB database.
<ul><li>You can install your own locally</li> <li>Use <a href="https://www.mongodb.com/atlas/database" target="_blank" rel="noopener noreferrer">AtlasDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul> <h2 id="task-0-get-the-starter-application"><a href="#task-0-get-the-starter-application" class="header-anchor">#</a> TASK 0: Get the Starter Application</h2> <p>Since we now have a database, setup is a little more involved:</p> <p>In your command line shell, run:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">git</span> clone --branch week-6-starter-code  https://github.com/joeappleton18/solent-room-finder.git week-6

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>Follow the instructions in the cloned project's <code>README.md</code> to set up your development version of the Solent Room Finder.</li></ul> <div class="custom-block tip"><p class="custom-block-title">Important Point</p> <p>‚≠êÔ∏è <strong>Taking too long to install NPM dependencies at university</strong>? <a href="https://ssu-my.sharepoint.com/:f:/g/personal/joe_appleton_solent_ac_uk/Eoq4m_ZibL1KviE7247Y01oBxBssJkRCaVQYB5h5LHm1nw" target="_blank" rel="noopener noreferrer">This is an odd issue, as the dependencies only take about 30-seconds to install on my, much slower, home network. To speed up the university installation you may just want to download the zip file of the project with all installed dependencies.<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h2 id="a-strategy-for-testing"><a href="#a-strategy-for-testing" class="header-anchor">#</a> A strategy for testing</h2> <p>First, let's consider our testing strategy for this application. Since this is a non-business critical web application, I am assuming the following position:</p> <ul><li>Test after the features are developed (e.g., we are not practicing TDD). I find this helps us focus; we are not continually jumping between features and tests.</li> <li>Take a user-first approach to testing.</li> <li>Test outcomes, not implementation. For instance, test that an error box gets shown but not the message itself.</li> <li>Start with wide-reaching integration tests (e.g., create, update, and delete a room).</li> <li>You should note that this is just my stance on testing this kind of application.</li> <li>Test on an environment that, as much as possible, mirrors production.</li> <li>Avoid mocking functionality.</li></ul> <p>Your testing strategy may differ, and as long as it is well justified, that's fine!</p> <h2 id="task-1-considering-a-testing-strategy-for-the-assessment-scenario"><a href="#task-1-considering-a-testing-strategy-for-the-assessment-scenario" class="header-anchor">#</a> TASK 1: Considering a Testing Strategy for the Assessment Scenario</h2> <div class="custom-block warning"><p class="custom-block-title">TASK 1: Considering a Testing Strategy for the Assessment Scenario</p> <p><a href="/devops_2022_2023_notes/assessment/scenario.html">In groups, or individually, list out in bullet points the testing strategy that you aim to take for the assessment scenario.</a></p></div> <h2 id="solent-he-have-a-problem"><a href="#solent-he-have-a-problem" class="header-anchor">#</a> Solent, He Have a Problem!</h2> <p><img src="/devops_2022_2023_notes/assets/img/failing_spec.3ee93053.png" alt=""></p> <blockquote><blockquote><p>Our tests are fragile.</p></blockquote></blockquote> <p>We have a problem with our current test setup! Don't believe me:</p> <ul><li>delete a room, by clicking the rubbish bin by a room in the room table.</li> <li>re-run your tests: <code>npm run cypress:run</code></li> <li>you  should now have two failed tests, ouch!</li></ul> <p>The culprit is this assertion in <code>cypress/e2e/home.cy.ts</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;shows a table containing a list of rooms&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 
 <span class="token operator">...</span>
 cy<span class="token punctuation">.</span><span class="token function">getByData</span><span class="token punctuation">(</span><span class="token string">&quot;room-item&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">&quot;have.length&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>	

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><blockquote><p><code>cypress/e2e/home.cy.ts</code></p></blockquote></blockquote> <p>Since we deleted a room, we now have 17 rooms in our table, not 18! We could re-seed the database; however, we don't necessarily want to re-set the database just to run the tests. In summary, we can't reliably run the tests against an unpredictable, changing database</p> <h2 id="the-solution-arrange-act-assert"><a href="#the-solution-arrange-act-assert" class="header-anchor">#</a> The Solution: ARRANGE-ACT-ASSERT</h2> <p><img src="/devops_2022_2023_notes/assets/img/arrange,act,assert.5bc3e852.png" alt=""></p> <blockquote><blockquote><p>A pattern for testing</p></blockquote></blockquote> <p>Above is a diagram of the common testing pattern arrange, act, assert.  Following this pattern, we must, before we act, arrange our application's state for testing. In our case, this means re-seeding the database. However, as we explored above, we don't want to re-seed our development database.</p> <p><img src="/devops_2022_2023_notes/assets/img/testing-environments.7992ec1b.png" alt=""></p> <blockquote><blockquote><p>The different environments we will, eventually, set up. Each environment must be stand alone.</p></blockquote></blockquote> <p>In order to implement our arrange, act, asset pattern, we need a dedicated test environment. In doing so, we can arrange this environment for acts and assertions.  Crucially, the test environment won't impact our development or production environments.</p> <p>Luckily, Next.js comes allows us to easily manage multiple environments. You have already taken advantage of this functionality. Currently, your application uses the <code>.env.local</code> file to see your enviroment. Next.js, however, allows us to use multiple environment files. <a href="https://nextjs.org/docs/basic-features/environment-variables" target="_blank" rel="noopener noreferrer">According to the documentation, Environment variables are looked up in the following places, in order, stopping once the variable is found<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li>process.env</li> <li>.env.$(NODE_ENV).local</li> <li>.env.local (Not checked when NODE_ENV is test.)</li> <li>.env.$(NODE_ENV)</li> <li>.env</li></ol> <div class="custom-block tip"><p class="custom-block-title">DEFINITION</p> <p>üìñ <strong>NODE_ENV</strong></p> <p><code>NODE_ENV</code> is an environment variable that was popularised by the express framework.</p></div> <p>According to the above, we just need to set <code>NODE_ENV</code> ti testing, and this means <code>.env.testing</code> will be used to populate out environment.</p> <h2 id="task-2-setting-up-multiple-environments"><a href="#task-2-setting-up-multiple-environments" class="header-anchor">#</a> Task 2: Setting up Multiple Environments</h2> <div class="custom-block warning"><p class="custom-block-title">TASK 2: Setting up Multiple Environments</p> <ul><li>We need to change <code>process.env.NODE_ENV</code> to <code>test</code>. To reliably do this across different operating systems we are going to install <code>cross-env</code>.
<ul><li>run: <code>npm install --save-dev cross-env</code></li></ul></li> <li>Next, set up in  <code>package.json</code> a script that runs our application in the test environment.</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code>
... 
<span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
... 

 <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=test  next dev&quot;</span><span class="token punctuation">,</span>
...

<span class="token punctuation">}</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><blockquote><p><code>package.json</code></p></blockquote></blockquote> <ul><li>Next, set up a <code>.env.test</code> file in the root of your project, and add a URL to the test database. Since we are using MongDB you just need to change the name of the database from <code>rooms</code> to something else (e,g., <code>room_test</code>). Here is what my connection string looks like:</li></ul> <div class="language-json line-numbers-mode"><pre class="language-json"><code>MONGODB_URI=&lt;url&gt;/rooms_test?retryWrites=<span class="token boolean">true</span>&amp;w=majority
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><p>If your application is currently running in command line, stop it (CTRL/CMD C).</p></li> <li><p>Run your application in test mode: <code>npm run test</code></p></li> <li><p>You should see after you run the command: <code>info - &lt;path&gt;.env.test</code></p></li> <li><p>You can now seed you database: visit <code>http://localhost:3001/api/utility</code>. You are seeding your test database, not your development database.</p></li></ul></div> <p>Now we have a test environment. Let's consider how we might use it to arrange tests. Crucially, each test should be stand-alone and not be dependent on other tests.  After each test runs, the database should return to its original known state (18 records).</p> <p>Let's consider how we might achieve this in Cypress.</p> <h2 id="task-3-arranging-tests"><a href="#task-3-arranging-tests" class="header-anchor">#</a> Task 3: Arranging Tests</h2> <div class="custom-block warning"><p class="custom-block-title">Arranging Tests</p> <ul><li>Open your Cypress console:</li> <li><code>npm run cypress:open</code></li> <li>we can place commands in <code>cypress/support/e2e.ts</code> that run before every test. Let's re-seed our database before each test. In <code>cypress/support/e2e.ts</code> add:</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  cy<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;I run before every test in every spec file!!!!!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cy<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:3000/api/utility/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//resets database after every test</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><blockquote><p><code>cypress/support/e2e.ts</code></p></blockquote></blockquote></div> <ul><li>Recall, the route <code>http://localhost:300/api/utility/</code> seeds our database. You can see the code behind this by looking at <code>src/pages/api/utility/index.ts</code></li></ul> <p><img src="/devops_2022_2023_notes/assets/img/test-runner-console.42e03224.png" alt=""></p> <ul><li><p>Re-run your tests from the cypress console. If you click on one of the green ticks you should see <code>I run before every test in every spec file!!!!!!</code></p></li> <li><p>Cypress recommend you set a base url, now seems like a good time to do this. In <code>cypress.config.ts</code> add a <code>baseURL</code> property:</p></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>defineConfig<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;cypress&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">e2e</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">baseUrl</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:3000&quot;</span><span class="token punctuation">,</span>
    <span class="token function">setupNodeEvents</span><span class="token punctuation">(</span><span class="token parameter">on<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// implement node event listeners here</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><blockquote><p><code>cypress.config.ts</code></p></blockquote></blockquote> <ul><li>You can now remove <code>http:localhost:3000</code> from your paths (e.g., <code>http:localhost:3000/create</code> becomes <code>/create</code> ). You'll need to update the paths in: <code>cypress/support/e2e.ts</code>, <code>cypress/e2e/create.cy.ts</code>, and <code>cypress/e2e/home.cy.ts</code>. For home and create this just involves updating the path in the forEach block.</li> <li>Restart the cypress console for these updates to take effect.</li></ul> <h2 id="task-3-arranging-tests-2"><a href="#task-3-arranging-tests-2" class="header-anchor">#</a> Task 3: Arranging Tests</h2> <div class="custom-block warning"><p class="custom-block-title">Adding some more tests</p> <ul><li><p>Now that we have a test environment set up let's write some more tests. Create the following files:</p></li> <li><p><code>cypress/e2e/delete.cy.ts</code></p></li> <li><p><code>cypress/e2e/update.cy.ts</code></p></li></ul> <p>Have a go at writing the following tests:</p> <p><strong>You will need to add <code>data-test=</code> attributes to elements your need to test.</strong></p> <p><strong>cypress/e2e/create.cy.ts</strong></p> <ul><li>add the test <code>it(&quot;creates a new room&quot;, ()</code></li> <li>use the test above to work out how to fill out the form</li> <li>After submission</li> <li>Check the success alert exists. This is what my code looks like: <code>cy.getByData(&quot;success-alert&quot;).should(&quot;exist&quot;);</code></li> <li>Visit the home page: <code>cy.visit(&quot;/&quot;);</code> and check there are 19 rooms in the table: <code>cy.getByData(&quot;room-item&quot;).should(&quot;have.length&quot;, 19);</code></li> <li>Check the room you created is in the table. Here is what my code looks like: <code>cy.getByData(&quot;room-item&quot;).contains(/RM1/);</code></li></ul> <p><strong>cypress/e2e/delete.cy.ts</strong></p> <ul><li>add the test <code>it(&quot;deletes a room&quot;, () =&gt; {</code></li> <li>check that the table has 18 rooms: <code>cy.getByData(&quot;room-item&quot;).should(&quot;have.length&quot;, 18);</code></li> <li><code>cy.getByData(&quot;delete-icon&quot;).eq(0).click();</code></li></ul> <p><strong>cypress/e2e/create.cy.ts (if you fly through the above)</strong></p> <ul><li>work out how to test that update works</li></ul> <p><a href="https://github.com/joeappleton18/solent-room-finder/tree/week-6-solutions" target="_blank" rel="noopener noreferrer">If you did not get very far with the above: you can grab the completed test files from here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h2 id="running-cypress-in-continuous-integration-ci"><a href="#running-cypress-in-continuous-integration-ci" class="header-anchor">#</a> Running Cypress in Continuous Integration (CI)</h2> <p>Would it not be great when we made a pull or pull request our tests ran as a GitHub workflow? Well! We can do just that. For the final task, let's consider how this might work.</p> <h2 id="task-4-ci-integration"><a href="#task-4-ci-integration" class="header-anchor">#</a> Task 4: CI Integration</h2> <div class="custom-block warning"><p class="custom-block-title">Task 4: CI Integration</p> <p>Create <code>.github/workflows/cypress.yaml</code> and add the following code:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">name</span><span class="token punctuation">:</span> E2E on Chrome

<span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>push<span class="token punctuation">,</span> pull_request<span class="token punctuation">]</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">install</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Cypress run
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> cypress<span class="token punctuation">-</span>io/github<span class="token punctuation">-</span>action@v3
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">browser</span><span class="token punctuation">:</span> chrome
          <span class="token key atrule">build</span><span class="token punctuation">:</span> npm run build
          <span class="token key atrule">start</span><span class="token punctuation">:</span> npm run start
          <span class="token key atrule">wait-on</span><span class="token punctuation">:</span> <span class="token string">&quot;http://localhost:3000&quot;</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">MONGODB_URI</span><span class="token punctuation">:</span> <span class="token string">&quot;&lt;add the url to your testing database&gt;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><blockquote><blockquote><p><code>.github/workflows/cypress.yaml</code>: ensure you update your  MONGODB_URI. If you want more security consider <a href="https://docs.github.com/en/actions/security-guides/encrypted-secrets" target="_blank" rel="noopener noreferrer">environment secrets<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Above, we build our application and then use <code>cypress-io/github-action@v3</code> to run the tests in the chrome, headless browser, pretty cool!</p></blockquote></blockquote> <ul><li>Next commit and deploy to a GitHub repo. You will need to set up your own repository, then go through the following process:</li></ul> <div class="language-command line-numbers-mode"><pre class="language-text"><code>git add -A 
git commit -m &quot;week 6 lesson completed&quot;
git remote remove origin 
git remote add origin &lt;your repo url&gt;
git push origin week-6-starter-code (you may need to append --force)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="/devops_2022_2023_notes/assets/img/e2e.5d41e2cd.png" alt=""></p> <ul><li><p>If all has gone well you should she a green tick on your repository. When you click on it, you'll see that your tests ran üéä üéä üéä üéä üéä üéä üéäüéä</p></li> <li><p>Finally, it's always a nice touch to add badges to your <code>README.MD</code> file. Git hub actions makes this easy, add the following to your <code>README.md</code>:</p></li></ul> <p><code>![](&lt;your repo's http address&gt;/actions/workflows/cypress.yaml/badge.svg)</code></p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ‚Üê
      <a href="/devops_2022_2023_notes/week-6/lecture.html" class="prev">
        Lecture
      </a></span> <span class="next"><a href="/devops_2022_2023_notes/week-7/lecture.html">
        Lecture
      </a>
      ‚Üí
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/devops_2022_2023_notes/assets/js/app.a48a6b8c.js" defer></script><script src="/devops_2022_2023_notes/assets/js/2.28c99d85.js" defer></script><script src="/devops_2022_2023_notes/assets/js/4.7049fa07.js" defer></script>
  </body>
</html>
